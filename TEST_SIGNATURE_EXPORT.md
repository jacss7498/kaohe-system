# 签名导出功能测试指南

## 测试步骤

### 1. 准备工作
- 确保后端服务正在运行（`npm run dev:backend`）
- 确保前端服务正在运行（`npm run dev:frontend`）
- 打开浏览器开发者工具（F12），切换到 Console 标签

### 2. 测试前提条件
- 确保至少有一个已完成的任务
- 确保该任务中至少有一个用户已经提交了评分（包含签名）

### 3. 测试步骤

1. **登录管理员账号**
   - 访问 http://localhost:5173
   - 使用管理员账号登录

2. **进入统计页面**
   - 点击"统计"或"数据统计"菜单
   - 选择一个已完成的任务

3. **导出评分表**
   - 点击"导出所有用户评分表"按钮
   - 观察浏览器控制台的输出

4. **检查控制台日志**
   应该看到类似以下内容：
   ```
   === 前端导出数据调试 ===
   总评分人数: X
   1. 评分人 XXX (ID: X): {hasSignature: true, signatureLength: XXXX, ...}
   签名统计: 共 X 人，其中 Y 人有签名
   ✓ 评分人 XXX: 签名已添加，长度 XXXX
   ```

5. **检查导出的HTML文件**
   - 文件应该自动下载
   - 打开下载的HTML文件
   - 检查表格最后一列"签名"列
   - 应该能看到签名图片（如果有签名的话）

### 4. 预期结果

**成功情况：**
- 控制台显示找到了签名数据
- 导出的HTML文件中，有签名的用户显示签名图片
- 没有签名的用户显示"未签名"

**失败情况排查：**

如果显示"未签名"：
1. 检查控制台日志，看是否有"✓ 找到评分人...的签名"的消息
2. 如果没有，说明数据库中可能没有签名数据
3. 如果有，但HTML中不显示，可能是HTML生成问题

### 5. 后端日志检查

查看后端控制台，应该看到：
```
=== 导出评分数据调试 ===
评分记录总数: X
✓ 找到评分人 X (XXX) 的签名，长度: XXXX
签名映射统计: {totalScorers: X, signaturesFound: Y, ...}
评分人 XXX (ID: X) 的签名: 存在，长度 XXXX
```

## 常见问题

### Q: 所有用户都显示"未签名"
**A:** 可能的原因：
1. 数据库中确实没有签名数据
2. 检查用户是否在提交评分时确实添加了签名
3. 查看后端日志，确认是否找到了签名数据

### Q: 控制台显示找到了签名，但HTML中不显示
**A:** 可能的原因：
1. HTML转义问题（已修复）
2. 图片路径格式问题
3. 浏览器安全策略阻止了base64图片显示

### Q: 如何验证数据库中是否有签名数据？
**A:** 可以使用SQLite工具查询：
```sql
SELECT scorer_id, COUNT(*) as count, 
       CASE WHEN signature IS NULL OR signature = '' THEN '无签名' ELSE '有签名' END as sig_status
FROM scores 
WHERE task_id = ? 
GROUP BY scorer_id, sig_status;
```

## 调试技巧

1. **查看完整的签名数据**：
   在控制台中，展开每个评分人的日志，查看 `signaturePreview` 字段
   应该看到类似 `data:image/png;base64,iVBORw0KGgo...` 的格式

2. **检查HTML源码**：
   打开导出的HTML文件，查看源码
   搜索 `<img src=` 应该能看到签名图片标签

3. **测试单个签名**：
   在控制台中复制一个签名数据，直接在浏览器地址栏输入：
   `data:text/html,<img src="[签名数据]">`
   看是否能显示图片










