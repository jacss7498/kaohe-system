# 系统更新说明

## 更新时间
2025-12-26

## 本次更新内容

### 1. ✅ Docker部署成功

- 成功在服务器（192.168.0.110）上部署Docker容器
- 前端服务：http://192.168.0.110:5173
- 后端API：http://192.168.0.110:3002/api
- 服务状态：运行正常 ✓

### 2. ✅ 修复登录问题

**问题描述**：
- 非管理员账号登录后自动跳回登录页

**问题原因**：
- `/auth/me` 接口查询了数据库中不存在的 `unit` 和 `must_change_password` 列
- 导致接口返回500错误，前端认为未登录

**解决方案**：
- 添加了数据库缺失的列（`unit`, `must_change_password`）
- 修复了所有相关API接口
- 重新构建并部署了后端服务

### 3. ✅ 初始化用户账号

**清理旧数据**：
- 删除了所有旧的测试账号
- 保留并更新了管理员账号

**创建新账号**：
- 领导班子成员：5人
- 负责人：29人
- 总计：35个账号（包括管理员）

**账号特点**：
- 用户名 = 姓名（如：韩冬的用户名就是"韩冬"）
- 初始密码统一为 `123456`
- 首次登录强制修改密码（管理员除外）

### 4. ✅ 完善密码管理功能

**强制修改密码**：
- 所有非管理员用户首次登录必须修改密码
- 密码最小长度：6位
- 修改成功后可正常使用系统

**管理员账号**：
- 用户名：`admin`
- 密码：`admin123`
- 无需修改密码

## 账号列表

详见 `USER_ACCOUNTS.md` 文件，包含：
- 完整的账号列表
- 登录说明
- 密码重置方法

## 部署信息

详见 `DEPLOYMENT.md` 文件，包含：
- 服务访问地址
- 常用管理命令
- 故障排查方法
- 数据备份方案

## 测试验证

### ✅ 管理员账号测试

```
用户名: admin
密码: admin123
结果: ✅ 登录成功，无需修改密码
```

### ✅ 普通用户测试

```
用户名: 韩冬
密码: 123456
结果: ✅ 登录成功，提示需要修改密码
```

## 数据库变更

### 新增列

`users` 表新增以下列：
- `unit` TEXT - 所属单位
- `must_change_password` INTEGER DEFAULT 1 - 是否需要强制修改密码

### 数据初始化

- 管理员账号：1个（admin/admin123，无需改密码）
- 领导班子：5个（密码123456，需要改密码）
- 负责人：29个（密码123456，需要改密码）

## 技术改进

1. **API接口修复**：
   - `/api/auth/login` - 返回完整用户信息
   - `/api/auth/me` - 正确读取所有字段
   - `/api/auth/first-change-password` - 支持首次修改密码

2. **数据库兼容**：
   - 添加了缺失的列
   - 保持了向后兼容性

3. **Docker部署**：
   - 后端服务正常运行
   - 数据持久化配置正确
   - 日志输出正常

## 已知问题

✅ 所有已知问题已修复

## 下一步建议

1. **用户管理功能**：
   - 建议添加管理员用户管理界面
   - 可查看所有用户
   - 可重置用户密码

2. **数据备份**：
   - 定期备份数据库文件
   - 建议每天自动备份

3. **安全加固**：
   - 考虑配置HTTPS
   - 加强密码策略（复杂度要求）
   - 添加登录日志审计

## 文件列表

本次更新创建/修改的文件：

| 文件名 | 说明 |
|--------|------|
| `DEPLOYMENT.md` | Docker部署文档 |
| `USER_ACCOUNTS.md` | 用户账号列表 |
| `ACCOUNT_INFO.md` | 账号信息说明 |
| `UPDATE_LOG.md` | 本文件 - 更新日志 |
| `migrate-db.js` | 数据库迁移脚本 |
| `backend/src/routes/auth.ts` | 认证路由修复 |

## 联系方式

如有问题，请查看相关文档或联系系统管理员。
